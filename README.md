# L432KC-CAN-interceptor
This is a repo for the CAN interceptor used for debugging helia developed during the 2021-2022 cycle. A nucleo-l432kc has been used for this board.

## About

CMake is used to build the software and generating a `.elf` file. The CMake framework of this project is based on [ObKo/stm32-cmake](https://github.com/ObKo/stm32-cmake).
This framework is used to develop applications for the STM32 - ST's ARM Cortex-Mx MCUs.
It uses cmake and GCC, along with newlib (libc), STM32Cube. Supports F0 F1 F2 F3 F4 F7 G0 G4 H7 L0 L1 L4 L5 U5 WB WL device families.

The [Makefile](Makefile) in this project has been generated by the STMCubeMX tool and it is superseded by the CMake framework. Nevertheless, the [Makefile](Makefile) can be used as a reference for creating/modifying [CMakeLists.txt](CMakeLists.txt).

## Requirements

* cmake >= 3.16
* [GCC toolchain with newlib (optional)](https://developer.arm.com/Tools%20and%20Software/GNU%20Toolchain)
* [STM32Cube package for appropriate STM32 family](https://www.st.com/en/embedded-software/stm32cube-mcu-mpu-packages.html)
* [Openocd for flashing and debugging](https://openocd.org/)
* [Cortex-Debug VSCode extension](https://marketplace.visualstudio.com/items?itemName=marus25.cortex-debug)

## Project contains

* CMake file, entry point of program, configured to build the binary for project: [CMakeLists.txt](CMakeLists.txt)
* Project files generated by the STM32CubeMX tool :
    1. [Core](Core), where the main project resides 
    2. [nucleo-l432kc-bmu-CAN-interceptor.ioc](nucleo-l432kc-bmu-CAN-interceptor.ioc), ioc file to configure peripherals settings with STM32CubeMX tool
* CMake toolchain file, that configures cmake to use the arm toolchain: [cmake/stm32_gcc.cmake](cmake/stm32_gcc.cmake).
* CMake module that contains useful functions: [cmake/stm32/common.cmake](cmake/stm32/common.cmake)
* CMake modules that contains information about each family - RAM/flash sizes, CPU types, device types and device naming (e.g. it can tell that STM32F407VG is F4 family with 1MB flash, 128KB RAM with CMSIS type F407xx)
* CMake toolchain file that can generate a tunable linker script [cmake/stm32/linker_ld.cmake](cmake/stm32/linker_ld.cmake)
* CMake module to find and configure CMSIS library [cmake/FindCMSIS.cmake](cmake/FindCMSIS.cmake)
* CMake module to find and configure STM32 HAL library [cmake/FindHAL.cmake](cmake/FindHAL.cmake)
* CMake modules for various libraries/RTOSes

## VSCode configuration

To configure VSCode and make sure that intellisense work properly, navigate to [.vscode/c_cpp_properties.json](.vscode/c_cpp_properties.json). Change the path of the STM32 package under "includePath". It should point to the path for the CMSIS and HAL library of the [appropriate family of STM32Cube package](https://www.st.com/en/embedded-software/stm32cube-mcu-mpu-packages.html).

For debugging, install the cortex-debug VSCode extension. It is responsible for flashing mcu with the `.elf` using openocd.
The specific settings for launching the cortex debugger can be found in [.vscode/launch.json](.vscode/launch.json). Once the `.elf` file has been generated in the `build` directory after running the cmake command listed at the bottom. The path of the `.elf` file should be set in "executable" under "configurations" in [.vscode/launch.json](.vscode/launch.json). 

To use stlink as a debugger, "interface/stlink.cfg" and "target/stm32f3x.cfg" ,which specifies the stm32 family, should be added to "configFiles". Those `.cfg` should be automatically detected by openocd when it is properly installed. To locate those `.cfg` and see the options avaliable, navigate to where openocd is installed.

## Peripherals configuration

The [STM32CubeMX tool](https://www.st.com/en/development-tools/stm32cubemx.html) has been used to generate the core files for this project. Peripherals can be configured by loading the [helia_lights_board.ioc](helia_lights_board.ioc) on the STM32CubeMX which provides a graphical interface to enable/update peripherals settings. Finally, the code can be generated by clicking the `Generate Code` button. It is important to only write code within the specified margin in all `.c` and `.h` files as anything written outside could be lost when new settings are applied with code generation. 

## Specific build commands for l432kc-can-interceptor

For configuring cmake and generating the build folder which contains the `.elf` file (remeber to update the `-DSTM32_CUBE_L4_PATH`),
```
    $ cmake -DCMAKE_TOOLCHAIN_FILE="/cmake/stm32_gcc.cmake" -DSTM32_CUBE_L4_PATH="C:\Users\vince\STM32Cube\Repository\STM32Cube_FW_L4_V1.17.1" -DCBUILD_TYPE=Debug -S . -B .\build\
```

Then build the `.elf` file with
```
    $ cmake --build .\build\
```

The `.elf` will be flashed onto the mcu when a cortex debug session (cortex-debug vscode extension required) has been launched. To launch it, press F5 key.

Alternatively, if you just want to flash the `.elf` onto mcu without launching a debugging session,
```
$ openocd -f interface/stlink.cfg -f target/stm32l4x.cfg -c "program build/l432kc-can-interceptor.elf verify reset"
```
